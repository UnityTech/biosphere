#!/usr/bin/ruby

require 'terraformation'
require 'optparse'
require 'ostruct'
require 'pp'

class TerraformationOpts

	def self.parse(args)

		options = OpenStruct.new
		options.build = "build"

		opt_parser = OptionParser.new do |opts|


			opts.banner = "Usage: \"terraformation [options] <action>\""

			opts.separator ""
			opts.separator "Actions:"
			opts.separator "\tjson\tWrite tf files as json into build directory"
			opts.separator ""

			opts.on_tail("-h", "--help", "Show this message") do
				puts opts
				exit
			end

			opts.on("--build PATH", "Directory where to build json files") do |path|
				options.build = path
			end

		end

		opt_parser.parse!(args)
		options
	end

end

options = TerraformationOpts.parse(ARGV)

if ARGV.length == 0
	STDERR.puts "No action spesified. Use -h to get help."
	exit -1
end

if ARGV[0] == "json" && ARGV[1]
	suite = Terraformation::Suite.new(ARGV[1])
	suite.load_all()

	if !File.directory?(options.build)
		STDERR.puts "Directory #{options.build} is not a directory or it doesn't exists."
		exit -1
	end

	count = 0
	suite.write_json_to(options.build) do |file_name, destination, str, proxy|
		puts "Wrote #{str.length} bytes from #{file_name} to #{destination} (#{proxy.output["resource"].length} resources)"
		count = count + 1
	end

	puts "Wrote #{count} files into #{options.build}"

end

